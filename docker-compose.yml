services:
  portfolio-server:
    container_name: stockelper-portfolio-server
    image: stockelper-portfolio-server:latest
    build:
      context: .
    ports:
      - "21008:21008"
    environment:
      # Server
      HOST: ${HOST:-0.0.0.0}
      PORT: ${PORT:-21008}
      DEBUG: ${DEBUG:-false}

      # DB (stockelper-fe Prisma의 DATABASE_URL과 호환되도록 둘 다 지원)
      # - 권장: DATABASE_URL=postgresql://user:pass@host:5432/postgres
      # - 선택: ASYNC_DATABASE_URL=postgresql+asyncpg://user:pass@host:5432/postgres
      DATABASE_URL: ${DATABASE_URL:-}
      ASYNC_DATABASE_URL: ${ASYNC_DATABASE_URL:-}
      ASYNC_DATABASE_URL_KSIC: ${ASYNC_DATABASE_URL_KSIC:-}

      # External APIs / Keys (필요한 엔드포인트에서만 사용)
      OPEN_DART_API_KEY: ${OPEN_DART_API_KEY:-}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}

      # (선택) schema 명이 stockelper_web가 아니라면 지정
      STOCKELPER_WEB_SCHEMA: ${STOCKELPER_WEB_SCHEMA:-public}

      KIS_MAX_REQUESTS_PER_SECOND: ${KIS_MAX_REQUESTS_PER_SECOND:-20}
      # (추천/분석 전용) KIS 호출 RPS 제한 (모의투자는 특히 낮게 권장: 1~2)
      KIS_ANALYSIS_MAX_REQUESTS_PER_SECOND: ${KIS_ANALYSIS_MAX_REQUESTS_PER_SECOND:-1}

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:21008/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - stockelper
    restart: unless-stopped

networks:
  stockelper:
    # 여러 레포(LLM/FE/Portfolio/Backtesting)를 같은 네트워크에 붙이기 위한 고정 이름
    external: true
    name: stockelper