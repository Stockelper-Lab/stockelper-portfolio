version: "3.8"

services:
  portfolio-server:
    container_name: stockelper-portfolio-server
    build:
      context: .
    ports:
      - "21010:21010"
    environment:
      # Server
      HOST: ${HOST:-0.0.0.0}
      PORT: ${PORT:-21010}
      DEBUG: ${DEBUG:-false}

      # DB (stockelper-fe Prisma의 DATABASE_URL과 호환되도록 둘 다 지원)
      # - 권장: DATABASE_URL=postgresql://user:pass@host:5432/postgres
      # - 선택: ASYNC_DATABASE_URL=postgresql+asyncpg://user:pass@host:5432/postgres
      DATABASE_URL: ${DATABASE_URL:-}
      ASYNC_DATABASE_URL: ${ASYNC_DATABASE_URL:-}
      ASYNC_DATABASE_URL_KSIC: ${ASYNC_DATABASE_URL_KSIC:-}

      # External APIs / Keys (필요한 엔드포인트에서만 사용)
      OPEN_DART_API_KEY: ${OPEN_DART_API_KEY:-}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}

      # KIS (portfolio_multi_agent buy/sell에서 사용)
      APP_KEY: ${APP_KEY:-}
      APP_SECRET: ${APP_SECRET:-}
      ACCESS_TOKEN: ${ACCESS_TOKEN:-}
      ACCOUNT_NO: ${ACCOUNT_NO:-}
      KIS_MAX_REQUESTS_PER_SECOND: ${KIS_MAX_REQUESTS_PER_SECOND:-20}

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:21010/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - stockelper
    restart: unless-stopped

networks:
  stockelper:
    # 여러 레포(LLM/FE/Portfolio/Backtesting)를 같은 네트워크에 붙이기 위한 고정 이름
    name: stockelper


